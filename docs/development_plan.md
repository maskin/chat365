# 開発計画書: 音声放送制御アプリ

## 1. プロジェクト概要

### 1.1 目標
社内・校内放送の自動化システムのMVPを8週間で開発し、基本的な音声認識・合成・自動放送機能を実現する。

### 1.2 成果物
- 動作するWebアプリケーション（フロントエンド + バックエンド）
- データベース設計・実装
- Google Cloud API統合
- 技術ドキュメント（運用手順書、APIドキュメント）

### 1.3 開発体制
- フルスタック開発者: 1名
- プロジェクトオーナー: 1名（レビュー・承認）

---

## 2. 開発フェーズ

### Phase 0: プロジェクト準備（Week 0）
**期間: 2-3日**

#### タスク
- [x] プロジェクト構成の確認
- [x] ドキュメントレビュー（README, HANDOVER, db_design, tech_validation）
- [ ] Google Cloudプロジェクトのセットアップ
  - APIの有効化（Speech-to-Text, Text-to-Speech）
  - サービスアカウントキーの作成
  - 認証情報の環境変数設定
- [ ] 開発環境のセットアップ
  - Python仮想環境の構築
  - Node.js/npm環境の確認
  - 依存パッケージのインストール
- [ ] Gitリポジトリの初期化
  - .gitignoreの設定
  - 初回コミット

#### 成果物
- Google Cloudプロジェクト（APIキー取得済み）
- 動作確認済みの開発環境

---

### Phase 1: コア技術検証（Week 1）
**期間: 5営業日**

#### 1.1 Google Cloud API検証（3日）

**タスク**
- [x] Speech-to-Text APIの動作確認
  - [x] サンプル音声ファイルの準備
  - [x] `speech_test.py`の実装・実行 (MP3対応済み)
  - [x] 日本語認識精度の確認
  - [x] 句読点付与の動作確認
- [ ] Text-to-Speech APIの動作確認
  - [x] `tts_test.py`の実装・実行
  - [x] 複数音声タイプのテスト（男性/女性/ニュートラル）
  - [x] イントネーション・自然さの評価
- [x] 音声ファイル再生の検証
  - [x] Python `subprocess` (`afplay`/`aplay`) でのMP3再生 (pygameから変更)
  - [ ] Linuxサーバーでの音声出力確認

**判定基準**
- ✅ 日本語音声が正確にテキスト化される
- ✅ 生成された音声が自然で聞き取りやすい
- ✅ サーバー側で音声ファイルが再生できる
- ❌ 上記が満たせない場合は代替手段を検討

#### 1.2 スケジューラー検証（2日）

**タスク**
- [x] APSchedulerのインストール・設定
- [x] 基本的なジョブスケジューリングのテスト
  - [x] 指定時刻でのジョブ実行
  - [x] 実行精度の測定（±5秒以内か）
- [x] データベースと連携したジョブ管理
  - [x] スケジュールをDBから読み込み
  - [x] 実行後のステータス更新

**判定基準**
- ✅ 指定時刻±5秒以内でジョブが実行される
- ✅ 複数ジョブの並行実行が可能

#### 成果物
- 技術検証レポート（`docs/tech_validation_result.md`）
- 検証用サンプルコード

---

### Phase 2: バックエンド基盤構築（Week 2-3）
**期間: 10営業日**

#### 2.1 データベース実装（2日）

**タスク**
- [x] SQLiteデータベースファイルの作成
- [x] `broadcasts`テーブルの実装（SQLAlchemy）
- [ ] マイグレーション管理の導入（Alembic）
- [ ] テストデータの投入
- [ ] 基本的なCRUD操作のテスト

**成果物**
- `database.py`（完成版）
- マイグレーションスクリプト
- `tests/test_database.py`

#### 2.2 API基盤の構築（3日）

**タスク**
- [x] Flask/FastAPIの基本構成
- [x] 基本的なRESTful API実装
  - `GET /api/broadcasts` (完成)
  - `POST /api/broadcasts` (完成)
- [ ] 追加API実装
  - `GET /api/broadcasts/{id}`
  - `PUT /api/broadcasts/{id}`
  - `DELETE /api/broadcasts/{id}`
- [ ] バリデーション処理の追加
- [ ] エラーハンドリングの統一

**成果物**
- `src/backend/app.py`（完成版）
- `src/backend/routes/`（APIルート分割）
- API仕様書（`docs/api_specification.md`）

#### 2.3 音声認識API統合（3日）

**タスク**
- [ ] Speech-to-Text APIのラッパー実装
  - `src/backend/services/speech_service.py`
- [ ] `/api/speech-to-text`エンドポイント実装
  - 音声ファイルのアップロード受付
  - Google Cloud APIへのリクエスト
  - テキスト変換結果の返却
- [ ] エラーハンドリング
  - API呼び出し失敗時のリトライ処理
  - タイムアウト処理
- [ ] 単体テストの作成

**成果物**
- `src/backend/services/speech_service.py`
- `tests/test_speech_service.py`

#### 2.4 音声合成API統合（2日）

**タスク**
- [ ] Text-to-Speech APIのラッパー実装
  - `src/backend/services/tts_service.py`
- [ ] 音声ファイル生成処理
  - テキストから音声ファイル（MP3）生成
  - 一時ファイルの管理
  - 音声ファイルの再生処理
- [ ] 単体テストの作成

**成果物**
- `src/backend/services/tts_service.py`
- `tests/test_tts_service.py`

---

### Phase 3: スケジューリング機能実装（Week 4）
**期間: 5営業日**

#### 3.1 スケジューラー実装（3日）

**タスク**
- [ ] APSchedulerの統合
  - `src/backend/scheduler.py`の実装
  - アプリケーション起動時にスケジューラー開始
- [ ] DBからのスケジュール読み込み
  - 起動時に未実行タスクを読み込み
  - ジョブとして登録
- [ ] タスク実行処理
  - 予定時刻になったら音声合成→再生
  - ステータス更新（SCHEDULED → QUEUED → BROADCASTING → COMPLETED）
- [ ] エラー時の処理
  - FAILED状態への更新
  - エラーログの記録
  - リトライ処理（最大3回）

**成果物**
- `src/backend/scheduler.py`
- `src/backend/tasks/broadcast_task.py`

#### 3.2 緊急放送機能（2日）

**タスク**
- [ ] `/api/emergency-broadcast`エンドポイント実装
  - 即時実行用タスクの登録
  - 優先度を最高（priority=2, EMERGENCY）に設定
- [ ] 優先度ベースのジョブ実行
  - 緊急放送を優先的に実行
  - 通常タスクの一時中断処理（INTERRUPTED）
- [ ] 統合テスト

**成果物**
- 緊急放送機能の完成
- `tests/test_emergency_broadcast.py`

---

### Phase 4: フロントエンド実装（Week 5-6）
**期間: 10営業日**

#### 4.1 UIデザインのリファクタリング（2日）

**タスク**
- [x] 基本的なHTML/CSS構造の確認
- [ ] レスポンシブデザインの調整
- [ ] UIコンポーネントの改善
  - ボタンスタイルの統一
  - カラースキームの適用
  - アイコンの追加（Font Awesome等）

**成果物**
- `src/frontend/styles.css`（改訂版）
- `src/frontend/index.html`（改訂版）

#### 4.2 タスク管理機能のUI実装（3日）

**タスク**
- [x] タスク一覧表示（基本実装済み）
- [ ] タスク詳細モーダルの実装
- [ ] タスク編集機能
  - 編集モーダルの実装
  - PUT APIとの連携
- [ ] タスク削除機能
  - 削除確認ダイアログ
  - DELETE APIとの連携
- [ ] フィルター・検索機能
  - ステータス別フィルター
  - 日付範囲検索

**成果物**
- `src/frontend/js/task_manager.js`

#### 4.3 音声入力機能のUI実装（3日）

**タスク**
- [ ] マイク入力の実装
  - ブラウザのMediaRecorder API使用
  - 録音開始/停止ボタン
  - 録音中の視覚的フィードバック
- [ ] 音声ファイルのアップロード
  - `/api/speech-to-text`へのPOST
  - ローディング表示
- [ ] 変換結果の表示・編集
  - テキストエリアへの自動入力
  - 手動編集可能
- [ ] エラーハンドリング
  - マイク権限エラー
  - API呼び出しエラー

**成果物**
- `src/frontend/js/voice_input.js`

#### 4.4 緊急放送機能のUI実装（1日）

**タスク**
- [ ] 緊急放送ボタンの実装
  - 目立つデザイン（赤色）
  - クリック時の確認ダイアログ
- [ ] 緊急放送モーダル
  - 放送内容入力フォーム
  - 音声入力対応
  - 即時実行ボタン

**成果物**
- `src/frontend/js/emergency_broadcast.js`

#### 4.5 リアルタイム更新機能（1日）

**タスク**
- [ ] WebSocketまたはポーリングによる自動更新
  - タスクステータスの自動反映
  - 実行中タスクの進行状況表示
- [ ] 通知機能
  - 放送開始/完了の通知
  - エラー通知

**成果物**
- `src/frontend/js/realtime_update.js`

---

### Phase 5: 統合テスト・デバッグ（Week 7）
**期間: 5営業日**

#### 5.1 単体テストの完成（2日）

**タスク**
- [ ] バックエンドの単体テストカバレッジ70%達成
  - `pytest`によるテスト
  - モック処理の実装（Google Cloud API）
- [ ] フロントエンドのテスト
  - 主要関数のテスト（Jest等）

**成果物**
- テストカバレッジレポート

#### 5.2 統合テスト（2日）

**タスク**
- [ ] E2Eテストシナリオの作成
  1. 通常放送の登録→自動実行
  2. 音声入力による放送登録→実行
  3. 緊急放送の即時実行
  4. タスクの編集・削除
  5. エラー発生時の挙動
- [ ] 各シナリオの実行・検証
- [ ] バグ修正

**成果物**
- E2Eテストレポート
- バグ修正リスト

#### 5.3 パフォーマンステスト（1日）

**タスク**
- [ ] 負荷テスト
  - 複数タスクの同時実行
  - API応答時間の測定
- [ ] スケジューリング精度の測定
  - 予定時刻との誤差測定（±5秒以内か）
- [ ] メモリ・CPU使用率の監視

**成果物**
- パフォーマンステストレポート

---

### Phase 6: ドキュメント整備・デプロイ準備（Week 8）
**期間: 5営業日**

#### 6.1 ドキュメント作成（3日）

**タスク**
- [ ] README.mdの更新
  - インストール手順
  - 使用方法
  - トラブルシューティング
- [ ] API仕様書の完成
  - 全エンドポイントの詳細
  - リクエスト/レスポンス例
- [ ] 運用手順書の作成
  - サーバーセットアップ手順
  - バックアップ・リストア手順
  - 障害対応手順
- [ ] 開発者向けドキュメント
  - アーキテクチャ図
  - コード規約
  - 拡張方法

**成果物**
- `README.md`（完成版）
- `docs/api_specification.md`
- `docs/operations_manual.md`
- `docs/developer_guide.md`

#### 6.2 デプロイ環境構築（2日）

**タスク**
- [ ] 本番環境用の設定ファイル作成
  - 環境変数の整理
  - `config.py`の実装
- [ ] デプロイスクリプトの作成
  - 依存関係のインストール
  - データベースマイグレーション
  - サービスの起動
- [ ] systemdサービス設定（Linux）
  - 自動起動設定
  - ログローテーション設定
- [ ] 本番環境での動作確認

**成果物**
- `deploy.sh`
- `pai.service`（systemd設定）
- デプロイ手順書

---

## 3. マイルストーン

| マイルストーン | 完了予定 | 判定基準 |
|---------------|---------|---------|
| M1: 技術検証完了 | Week 1終了時 | Google Cloud API・スケジューラーが正常動作 |
| M2: バックエンド完成 | Week 3終了時 | 全API実装完了、単体テストPass |
| M3: スケジューリング実装完了 | Week 4終了時 | 自動放送・緊急放送が動作 |
| M4: フロントエンド完成 | Week 6終了時 | 全UI機能実装完了 |
| M5: 統合テスト完了 | Week 7終了時 | E2Eテスト全Pass、バグ修正完了 |
| M6: MVP完成 | Week 8終了時 | ドキュメント整備、デプロイ可能 |

---

## 4. リスク管理と対策

### 4.1 技術リスク

| リスク | 発生確率 | 影響度 | 対策 | 担当 |
|--------|---------|-------|------|-----|
| Google Cloud API精度不足 | 中 | 高 | Week 1で徹底検証、代替API検討 | 開発者 |
| スケジューリング精度問題 | 低 | 中 | APScheduler以外のツール検討（Celery等） | 開発者 |
| 音声デバイス互換性 | 中 | 中 | 複数環境でテスト、FAQ整備 | 開発者 |
| ブラウザマイクAPI制約 | 低 | 低 | HTTPS必須を明記、代替手段案内 | 開発者 |

### 4.2 スケジュールリスク

| リスク | 発生確率 | 影響度 | 対策 | 担当 |
|--------|---------|-------|------|-----|
| 技術検証の遅延 | 中 | 高 | Week 1を厳守、3日で判断 | 開発者 |
| 機能実装の遅延 | 中 | 中 | 優先度を明確化、Phase 2機能は削減可 | PO |
| バグ修正の長期化 | 低 | 中 | 早期テスト開始、週次レビュー | 開発者 |

### 4.3 外部依存リスク

| リスク | 発生確率 | 影響度 | 対策 | 担当 |
|--------|---------|-------|------|-----|
| Google Cloud障害 | 低 | 高 | 障害時の運用手順策定 | PO |
| API無料枠超過 | 中 | 中 | 使用量監視アラート設定 | 開発者 |
| ネットワーク不安定 | 低 | 中 | リトライ処理・タイムアウト設定 | 開発者 |

---

## 5. 品質管理

### 5.1 コード品質

**基準**
- Pythonコード: PEP 8準拠（Black, Flake8使用）
- JavaScriptコード: ESLint使用
- 関数・クラスのドキュメント文字列必須
- 複雑度: McCabe複雑度 < 10

**チェックポイント**
- 毎週金曜日にコードレビュー
- コミット前にlinter実行

### 5.2 テスト品質

**基準**
- 単体テストカバレッジ: 70%以上
- E2Eテスト: 主要5シナリオが全Pass
- API負荷テスト: 50req/min で正常動作

**チェックポイント**
- Phase 5でテスト週間を設定
- CI/CDパイプライン（GitHub Actions等）の導入検討

### 5.3 ドキュメント品質

**基準**
- README.mdに基本的な使用方法記載
- API仕様書が完全（全エンドポイント記載）
- 運用手順書でトラブルシューティング可能

**チェックポイント**
- Week 8でドキュメントレビュー
- 第三者による理解度チェック

---

## 6. コミュニケーション計画

### 6.1 定例ミーティング

**週次ミーティング（毎週月曜日 10:00-10:30）**
- 前週の進捗報告
- 今週のタスク確認
- リスク・課題の共有

**デイリースタンドアップ（毎日15分）**
- 昨日の成果
- 今日の予定
- ブロッカーの確認

### 6.2 報告体制

**週次レポート（毎週金曜日）**
- 完了タスク一覧
- 次週の計画
- リスク・課題の状況
- スケジュール遅延の有無

**マイルストーンレビュー**
- 各マイルストーン完了時にレビューミーティング
- デモンストレーション
- 次フェーズのGo/No Go判断

---

## 7. 開発環境・ツール

### 7.1 開発ツール

| カテゴリ | ツール | 用途 |
|---------|-------|------|
| IDE | VS Code / PyCharm | コード編集 |
| バージョン管理 | Git + GitHub | ソースコード管理 |
| プロジェクト管理 | GitHub Projects / Trello | タスク管理 |
| ドキュメント | Markdown | 技術ドキュメント |

### 7.2 開発環境

**バックエンド**
- Python 3.9以上
- Flask 2.x / FastAPI 0.100+
- SQLAlchemy 2.x
- APScheduler 3.x
- pytest

**フロントエンド**
- HTML5 / CSS3
- JavaScript (ES6+)
- Fetch API

**インフラ**
- SQLite（開発環境）
- PostgreSQL（本番環境推奨）
- Linux (Ubuntu 20.04+)

### 7.3 外部サービス

- Google Cloud Speech-to-Text API
- Google Cloud Text-to-Speech API
- Google Cloud Console（認証情報管理）

---

## 8. デプロイ計画

### 8.1 デプロイ環境

**推奨スペック**
- CPU: 2コア以上
- メモリ: 4GB以上
- ストレージ: 20GB以上
- OS: Ubuntu 20.04 LTS以上

**必須ソフトウェア**
- Python 3.9+
- pip
- オーディオ出力デバイス
- インターネット接続

### 8.2 デプロイ手順

1. サーバーセットアップ
   - OSインストール・初期設定
   - 必要なパッケージインストール
2. アプリケーションデプロイ
   - リポジトリクローン
   - 依存関係インストール
   - 環境変数設定
3. データベースセットアップ
   - マイグレーション実行
4. サービス起動
   - systemdサービス登録
   - 自動起動設定
5. 動作確認
   - ヘルスチェック
   - テスト放送実行

### 8.3 運用開始後

**監視項目**
- アプリケーションログ
- エラー率
- API使用量（Google Cloud）
- ディスク使用量

**メンテナンス計画**
- 週次: ログ確認、バックアップ確認
- 月次: セキュリティアップデート適用
- 四半期: 機能改善の検討

---

## 9. Phase 2以降の展望

### 9.1 機能拡張候補

**優先度: 高**
- 繰り返し放送機能（毎日・毎週・毎月）
- チャイム音の自動再生
- 放送内容テンプレート機能

**優先度: 中**
- 複数音声デバイス対応
- ゾーン別放送
- ユーザー認証・権限管理

**優先度: 低**
- 多言語対応（英語・中国語等）
- スマートフォンアプリ
- 音声ファイルのアーカイブ機能

### 9.2 技術的改善

- PostgreSQL移行（スケーラビリティ向上）
- Docker化（デプロイ簡易化）
- CI/CDパイプライン構築
- ログ分析基盤（ELK Stack等）
- 監視ツール導入（Prometheus + Grafana）

---

## 10. 付録

### 10.1 用語集

| 用語 | 説明 |
|-----|------|
| MVP | Minimum Viable Product（実用最小限の製品） |
| TTS | Text-to-Speech（音声合成） |
| STT | Speech-to-Text（音声認識） |
| E2E | End-to-End（エンドツーエンド） |
| CRUD | Create, Read, Update, Delete |

### 10.2 参考資料

- [Google Cloud Speech-to-Text ドキュメント](https://cloud.google.com/speech-to-text/docs)
- [Google Cloud Text-to-Speech ドキュメント](https://cloud.google.com/text-to-speech/docs)
- [APScheduler ドキュメント](https://apscheduler.readthedocs.io/)
- [maskin/pai](https://github.com/maskin/pai)

---

**文書管理情報**
- 作成日: 2025-11-18
- 最終更新日: 2025-11-18
- バージョン: 1.0
- 作成者: プロジェクトチーム
- 承認者: （要定義）

**変更履歴**
| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-11-18 | 1.0 | 初版作成 | プロジェクトチーム |
