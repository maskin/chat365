# 要件定義書: 音声放送制御アプリ

## 1. プロジェクト概要

### 1.1 目的
社内・校内放送の自動化により、担当者の負担軽減と情報伝達の正確性・確実性を向上させる。

### 1.2 ターゲットユーザー
- 学校の事務職員・放送委員
- 企業の総務・広報担当者
- 施設管理者

### 1.3 解決する課題
- 放送時刻に合わせた人的リソースの拘束
- 放送忘れや時刻ミスによる情報伝達の失敗
- 緊急時の迅速な放送実施の困難さ
- 定型放送の繰り返し作業による非効率

---

## 2. 機能要件

### 2.1 MVP (Minimum Viable Product) 機能

#### 2.1.1 放送タスク管理機能
**優先度: 高 | 難易度: 中**

- **FR-001: タスク登録**
  - ユーザーが放送内容（テキスト）、放送予定日時、優先度を指定してタスクを登録できる
  - 入力方法: フォーム入力 / 音声入力（Speech-to-Text API使用）
  - 必須項目: 放送内容、放送日時
  - 任意項目: タスク名、優先度、繰り返し設定

- **FR-002: タスク一覧表示**
  - 登録済みの放送タスクを日時順に一覧表示できる
  - 表示項目: タスク名、放送内容（省略形）、予定日時、ステータス、優先度
  - フィルタリング: ステータス別（予定、実行中、完了、失敗）

- **FR-003: タスク詳細表示**
  - 個別タスクの詳細情報を表示できる
  - 表示項目: すべての登録情報、実行履歴、エラーログ

- **FR-004: タスク編集**
  - 「予定」ステータスのタスクを編集できる
  - 編集可能項目: 放送内容、放送日時、優先度

- **FR-005: タスク削除**
  - 「予定」ステータスのタスクを削除できる
  - 削除確認ダイアログを表示する

#### 2.1.2 音声認識機能
**優先度: 高 | 難易度: 高**

- **FR-011: 音声入力開始**
  - ブラウザのマイクAPIを利用して音声を録音できる
  - 録音中の視覚的フィードバック（録音アイコン点滅）

- **FR-012: 音声からテキスト変換**
  - 録音した音声をGoogle Cloud Speech-to-Text APIでテキスト化
  - 対応言語: 日本語（ja-JP）
  - 自動句読点付与を有効化

- **FR-013: 変換結果の編集**
  - 変換されたテキストを編集・確認してから登録できる

#### 2.1.3 音声合成・自動放送機能
**優先度: 高 | 難易度: 高**

- **FR-021: 自動スケジュール実行**
  - 登録された予定日時にタスクを自動実行する
  - スケジューラー（APScheduler）を使用
  - 実行精度: ±5秒以内

- **FR-022: テキスト音声変換**
  - 放送内容をGoogle Cloud Text-to-Speech APIで音声ファイル化
  - 音声設定: 日本語（ja-JP）、性別選択可能
  - 出力形式: MP3

- **FR-023: 音声ファイル再生**
  - 生成された音声ファイルをサーバー側で再生
  - 再生完了後、ステータスを「完了」に更新

- **FR-024: ステータス管理**
  - タスクステータスの自動更新
    - SCHEDULED（予定）→ QUEUED（待機中）→ BROADCASTING（放送中）→ COMPLETED（完了）
  - エラー発生時は FAILED（失敗）に更新し、エラーログを記録

#### 2.1.4 緊急放送機能
**優先度: 高 | 難易度: 中**

- **FR-031: 即時放送**
  - 現在時刻で即座に放送を実行できる
  - 優先度を最高（EMERGENCY）に自動設定
  - 通常タスクより優先して実行

- **FR-032: 実行中タスクの中断**
  - 緊急放送時、実行中の通常タスクを一時中断できる
  - 中断されたタスクはINTERRUPTEDステータスとなる

#### 2.1.5 システム監視機能
**優先度: 中 | 難易度: 低**

- **FR-041: 実行ログの記録**
  - すべてのタスク実行結果をログとして記録
  - 記録項目: 実行日時、ステータス、エラー情報、再生時間

- **FR-042: エラー通知**
  - タスク実行失敗時にUI上で通知を表示
  - エラー内容をログとして保存

---

### 2.2 将来的な拡張機能（Phase 2以降）

#### 2.2.1 繰り返し放送機能
**優先度: 中 | 難易度: 中**

- 毎日、毎週、毎月などの定期的な放送を設定可能
- チャイム音の自動再生機能

#### 2.2.2 複数音声デバイス対応
**優先度: 中 | 難易度: 高**

- 複数のスピーカー/放送設備への同時出力
- ゾーン別放送（特定エリアのみに放送）

#### 2.2.3 放送内容のテンプレート化
**優先度: 低 | 難易度: 低**

- よく使う放送内容をテンプレートとして保存
- プレースホルダー機能（日付、曜日などの自動挿入）

#### 2.2.4 権限管理・多言語対応
**優先度: 低 | 難易度: 中**

- ユーザー認証・権限管理（管理者/一般ユーザー）
- 英語・中国語などの多言語音声合成対応

---

## 3. 非機能要件

### 3.1 性能要件

- **NFR-001: レスポンス時間**
  - UI操作のレスポンス: 1秒以内
  - 音声認識処理: 音声時間の2倍以内（10秒の音声なら20秒以内）
  - 音声合成処理: 5秒以内（100文字程度）

- **NFR-002: スケジューリング精度**
  - 予定時刻からの誤差: ±5秒以内
  - システム時刻とのずれを定期監視

- **NFR-003: 同時実行**
  - 同時タスク実行数: 最大3件まで対応
  - 緊急放送は常に最優先で実行

### 3.2 可用性要件

- **NFR-011: 稼働時間**
  - 目標稼働率: 99%以上（月次）
  - メンテナンス時間: 深夜帯に週1回程度

- **NFR-012: エラー処理**
  - API呼び出し失敗時の自動リトライ（最大3回）
  - ネットワークエラー時のフォールバック処理

### 3.3 セキュリティ要件

- **NFR-021: 認証情報管理**
  - Google Cloud APIキーは環境変数で管理
  - .envファイルを.gitignoreに追加

- **NFR-022: 入力検証**
  - XSS対策: ユーザー入力のエスケープ処理
  - SQLインジェクション対策: ORMの使用

### 3.4 保守性要件

- **NFR-031: ログ管理**
  - アプリケーションログの自動ローテーション
  - エラーログの保持期間: 3ヶ月

- **NFR-032: データバックアップ**
  - データベースの日次バックアップ
  - バックアップデータの保持期間: 7日間

### 3.5 互換性要件

- **NFR-041: ブラウザ対応**
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（最新版）
  - Edge（最新版）

- **NFR-042: OS対応**
  - サーバー: Linux（Ubuntu 20.04以降推奨）
  - 開発環境: Windows, macOS, Linux

---

## 4. 技術制約

### 4.1 外部API依存
- Google Cloud Speech-to-Text API
  - 月間無料枠: 60分まで
  - 超過時の従量課金に注意
- Google Cloud Text-to-Speech API
  - 月間無料枠: 400万文字まで

### 4.2 音声デバイス
- サーバー側で音声を再生するため、サーバーにオーディオ出力デバイスが必要
- Linuxの場合、ALSA/PulseAudioの設定が必要

### 4.3 ネットワーク
- インターネット接続が必須（Google Cloud APIアクセスのため）
- ネットワーク断時は音声認識・合成機能が利用不可

---

## 5. インターフェース要件

### 5.1 ユーザーインターフェース

#### 5.1.1 メイン画面
- ヘッダー: アプリ名、現在時刻
- サイドバー: ナビゲーションメニュー
  - ダッシュボード
  - 放送スケジュール
  - 履歴
  - 設定
- メインエリア: 各画面のコンテンツ表示

#### 5.1.2 放送スケジュール画面
- 放送一覧テーブル
- 「＋新規放送」ボタン（右上）
- 「🎙️緊急放送」ボタン（右上、赤色）
- フィルター・検索機能

#### 5.1.3 新規登録モーダル
- フォーム
  - タスク名（任意）
  - 放送内容（テキストエリア）
  - 放送日時（日付・時刻ピッカー）
  - 優先度（選択: 通常/重要/緊急）
- 「🎤音声入力」ボタン
- 「登録」「キャンセル」ボタン

### 5.2 API仕様

#### 5.2.1 放送タスク一覧取得
```
GET /api/broadcasts
Response: 
{
  "broadcasts": [
    {
      "id": 1,
      "uuid": "...",
      "content": "本日の予定をお知らせします",
      "scheduled_at": "2025-11-18T09:00:00+09:00",
      "priority": 0,
      "status": "SCHEDULED",
      "created_at": "2025-11-17T15:30:00+09:00"
    },
    ...
  ]
}
```

#### 5.2.2 放送タスク登録
```
POST /api/broadcasts
Request Body:
{
  "content": "本日の予定をお知らせします",
  "scheduled_at": "2025-11-18T09:00:00+09:00",
  "priority": 0,
  "task_type": "REGULAR"
}
Response:
{
  "success": true,
  "broadcast_id": 1,
  "uuid": "..."
}
```

#### 5.2.3 音声認識
```
POST /api/speech-to-text
Request: multipart/form-data
  - audio_file: (audio file)
Response:
{
  "success": true,
  "transcript": "本日の予定をお知らせします"
}
```

#### 5.2.4 緊急放送
```
POST /api/emergency-broadcast
Request Body:
{
  "content": "緊急連絡です"
}
Response:
{
  "success": true,
  "broadcast_id": 123
}
```

#### 5.2.5 タスク更新
```
PUT /api/broadcasts/{id}
Request Body:
{
  "content": "更新された内容",
  "scheduled_at": "2025-11-18T10:00:00+09:00"
}
```

#### 5.2.6 タスク削除
```
DELETE /api/broadcasts/{id}
Response:
{
  "success": true
}
```

---

## 6. データ要件

### 6.1 データモデル
詳細は `db_design.md` を参照。

### 6.2 データ保持期間
- アクティブタスク（broadcasts）: ステータスがCOMPLETED/FAILED/CANCELLEDになってから7日間
- 履歴ログ（broadcast_log）: 3ヶ月間

### 6.3 データ移行
Phase 2以降でbroadcast_logテーブルへの自動アーカイブ処理を実装予定。

---

## 7. 受け入れ基準

### 7.1 MVP完了の定義
以下のすべての機能が正常に動作すること:
1. フォームから放送タスクを登録できる
2. 音声入力から放送タスクを登録できる
3. 予定時刻になったら自動で放送が実行される
4. 緊急放送ボタンから即座に放送が実行される
5. タスクの一覧表示・詳細表示・編集・削除ができる
6. エラー発生時に適切なログが記録される

### 7.2 品質基準
- 単体テストカバレッジ: 70%以上
- E2Eテスト: 主要フロー5パターンが正常動作
- ドキュメント整備: README、API仕様書、運用手順書

---

## 8. 制約事項・前提条件

### 8.1 制約事項
- 予算: Google Cloud API無料枠内での運用
- 開発期間: MVP完成まで8週間
- 開発体制: 1名（フルスタック開発者）

### 8.2 前提条件
- Google Cloudアカウントが利用可能
- 開発環境にPython 3.9以上、Node.js 16以上がインストール済み
- サーバー環境にオーディオ出力デバイスが接続されている

---

## 9. 変更管理

### 9.1 要件変更プロセス
1. 変更要望の提出
2. 影響範囲の分析
3. 優先度の判定
4. スケジュールへの組み込み
5. 実装・テスト
6. 本ドキュメントの更新

### 9.2 承認者
プロジェクトオーナー（要定義）

---

## 10. リスク管理

### 10.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| Google Cloud APIの精度不足 | 高 | 事前検証を実施（tech_validation.md） |
| スケジューラーの精度問題 | 中 | APSchedulerの動作検証、システム時刻同期 |
| 音声デバイスの互換性 | 中 | 複数環境でテスト、フォールバック処理 |

### 10.2 運用リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| API無料枠の超過 | 中 | 使用量の監視、アラート設定 |
| ネットワーク障害 | 高 | オフライン時の動作検討（Phase 2） |
| サーバーダウン | 高 | 監視ツール導入、自動再起動設定 |

---

**文書管理情報**
- 作成日: 2025-11-18
- 最終更新日: 2025-11-18
- バージョン: 1.0
- 作成者: プロジェクトチーム
